<!DOCTYPE html>
<html>
    <head>
        <script src="./adif_parser.js"></script>
        <script src="./moment.js"></script>
        <script src="./moment-timezone.js"></script>
        <script type="text/javascript">
            let modified = new Date();
            let str = modified.toISOString();
            document.write('<link href="./sytle-common.css?t=' + str + '" rel="stylesheet" type="text/css">');
        </script>
        <link rel="stylesheet" type="text/css" href="style-intl-card.css" id="css-cardsize">
    </head>

    <body onload="cssSelector('intl-card')">
        <header class="no-print">
            <h2 style="font-size:large;">
                ADIF -> QSL Maker
            </h2>

            <p> (c) Riku Suda (JR2KHB). 
                <ul>
                    <li>2022-12-20: ver 0.1.0 alpha (first publishing, experimental)</li>
                    <li>2023-01-01: ver 0.1.1 alpha (experimental)</li>
                    <li>2023-01-09: ver 0.1.2 alpha (experimental)</li>
                </ul>
            </p>
            <p>GitHub repository: <a href="https://github.com/rikusuda19/ADIF2QSL_webtool" target="_blank">https://github.com/rikusuda19/ADIF2QSL_webtool</a>                
        </header>

        <hr class="no-print">
        
        <div class="no-print">
            <p>

                <label for="list_cardSize">Card Size: </label>
                <select id="list_cardSize" onchange="cssSelector(this.value)">
                    <option value="intl-card" selected>International card size (90mm * 140mm)</option>
                    <option value="ja-card">JA card size (100mm * 150mm)</option>
                    <option value="sticker">Sticker (A4 Portrait)</option>
                </select>
            </p>
            
            <p>
                <input type="checkbox" checked id="chk_displayOP" onChange="switchOPField();"></input>
                <label for="chk_displayOP">Display OP column</label>
                <label for="txt_opDefault" style="margin-left:10px;">Default:</label>
                <input type="text" id="txt_opDefault" maxlength="20" size="25">
            </p>

            <p>
                <input type="checkbox" checked id="chk_displayDE" onchange="switchDEField();"></input>
                <label for="chk_displayDE">Display DE column</label>
                <label for="txt_deDefault" style="margin-left:10px;">Default:</label>
                <input type="text" id="txt_deDefault" maxlength="20" size="25">
            </p>
            <p>
                <input type="checkbox" checked id="chk_useJSTForJA"></input>
                <label for="chk_useJSTForJA">Use JST (= UTC+9) for JA stations</label>
            </p>
            <p>
                <input type="checkbox" checked id="chk_orderdByJARLRule"></input>
                <label for="chk_orderdByJARLRule">Order by JARL Bureau's Rule</label>
            </p>
            <p>
                <label for="num_maxRows">Max number of QSO data per card:</label>
                <input type="number" id="num_maxRows" min="1" max="100" value="10">
            </p>

            <p>
                <label for="btn_imgFile">QSL Logo</label>
                <input id="btn_imgFile" type="file" accept="image/*" onChange="btn_imgFile_clicked(this.files)" ></input>
            </p>

            <p>
                <label for="btn_adifFile">ADIF File</label>
                <input id="btn_adifFile" type="file" accept=".adi, .txt" onChange="btn_adifFile_clicked(this.files)" ></input>
            </p>

            <p>
                <button id="btn_process" type="button" onclick="btn_adifFile_clicked(document.getElementById('btn_adifFile').files);">Reload</button>
            </p>

            <p id="txt_status">
                Choose an ADIF File.
            </p>

        </div>

        <hr>

        <div id="qsl_area">
            <section class="qsl_section" id="qsl_template">
                <div id="qsl_control_template" class="no-print qsl_control">
                    
                    <div style="margin-right:2mm; display:inline-block;">
                        <input type="checkbox" id="chk_JARLStyleFrame_template" class="no-print chk_JARLStyleFrame" checked>
                        <label for="chk_JARLStyleFrame_template">JARL style</label>
                    </div>

                    <div style="margin-right:2mm; display:inline-block;">
                        <label for="txt_qslto_callsign_template">QSL to</label>
                        <input type="text" id="txt_qslto_callsign_template" class="no-print txt_qslto_callsign" maxlength="9" size="10">
                    </div>

                    <div style="margin-right:2mm; display:inline-block;">
                        <input type="checkbox" id="chk_via_template" class="no-print chk_via">
                        <label for="chk_via_template">VIA</label>
                    </div>

                    <input type="button" id="button_redraw_template" class="no-print button_redraw" value="Redraw" onclick="qslTo_redraw(this.parentNode.parentNode.id)">

                </div>


                <div class="page">
                    <div class="txt_via hidden" id="txt_via_template">VIA</div>

                    <table class="wrapper_to_radio">
                        <tr><th>TO RADIO</th></tr>
                        <tr><td class="box_to_radio"></td></tr>
                    </table>

                    <table class="table_bureau_call">
                        <tbody>
                            <tr>
                                <td class="red_bordered"></td>
                                <td class="red_bordered"></td>
                                <td class="red_bordered"></td>
                                <td class="red_bordered"></td>
                                <td class="red_bordered"></td>
                                <td class="red_bordered"></td>
                                <td class="red_bordered"></td>   
                            </tr> 
                        </tbody>
                    </table>

                    <div class="data_area">
                        <div class="statement">Confirming our QSO</div>
                        <table class="table_qsoData" id="table_qsoData_template">
                            <thead>
                                <tr>
                                    <td></td>
                                    <td class="tablecell_timezone" id="tablecell_timezone_template"></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <th class="qsoHeaderCell qsoHeader_date">DATE</th>
                                    <th class="qsoHeaderCell qsoHeader_time">TIME</th>
                                    <th class="qsoHeaderCell qsoHeader_freq">FREQ</th>
                                    <th class="qsoHeaderCell qsoHeader_mode">MODE</th>
                                    <th class="qsoHeaderCell qsoHeader_report">RST</th>
                                    <th class="qsoHeaderCell qsoHeader_op">OP</th>
                                    <th class="qsoHeaderCell qsoHeader_de">DE</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>

                            </tfoot>
                        </table>
                    </div>

                    <div class="info_area">
                        <img class="qslImage" />
                    </div>

                </div>
            </section>

        </div>
        
        <script>
            const doc_body = document.getElementById("qsl_area");
            const qsl_template = document.getElementById("qsl_template");

            const statusTextArea = document.getElementById("txt_status");

            const JACallSignRegex = /^(?<prefix>J[A-S]|7[J-N]|8[J-N])(?<area>\d)(?<suffix>[0-9A-Za-z]+)(?:\/(?<modifier>.+))?$/i;

            let qslImage = "";

            let cardCounter = 0;

            const repaint = async () => {
                for (let i = 0; i < 2; i++) {
                    await new Promise(resolve => requestAnimationFrame(resolve));
                }
            };

            // This idea for repainting is from 
            // https://qiita.com/kerupani129/items/3d26fef39e0e44101aad

            const btn_adifFile_clicked =
                async (files) => 
                {
                    doc_body.innerHTML = "";
                    cardCounter = 0;
                    statusTextArea.textContent = "Processing...";

                    await repaint();
                    Array.from(files).forEach(
                        file => 
                        readFile(file, 
                            (
                                s => {
                                    display_QSO_data(parse_adi(s));
                                    statusTextArea.textContent = cardCounter + " QSL card" + (cardCounter > 1 ? "s have" : " has") + " been produced."
                                }
                            ),
                            (
                                () => {
                                    statusTextArea.textContent = "FILE ERROR!"
                                }
                            )
                        )
                    );
                    await repaint();
                    if(!cardCounter){
                        statusTextArea.innerText = "Choose an ADIF file."
                    }
                }


            const btn_imgFile_clicked = 
                async (files) => 
                {
                    await repaint();
                    Array.from(files).forEach(
                        file => 
                        readImage(file, 
                            (
                                s => {
                                    qslImage = s || "";
                                }
                            ),
                            (
                                () => {
                                    qslImage = "";
                                }
                            )
                        )
                    );
                    await repaint();
                    document.querySelectorAll("img.qslImage").forEach(
                        elm => elm.setAttribute("src", qslImage)
                    );
                }



            function readFile(file, callback_success, callback_fail){

                let file_reader = new FileReader();


                file_reader.onload = function(event){
                    callback_success(event.target.result);
                };

                file_reader.onerror = function(event){
                    callback_fail();
                };

                file_reader.readAsText(file);
                
            }


            function readImage(file, callback_success, callback_fail){
                let file_reader = new FileReader();

                file_reader.onload = function(event){
                    callback_success(event.target.result);
                };

                file_reader.onerror = function(event){
                    callback_fail();
                };

                file_reader.readAsDataURL(file);
            }


           function parse_adi(adifStr){
                let ap = new AdifParser(adifStr);
                return ap.parseTopLevel();
            }

            function display_QSO_data(adifObj){
                // ADIF records
                let records = adifObj?.records;

                // Get the list of "callsign" value to obtain unique callsign list
                let callList = Array.from(new Set(records?.map(elm => elm.call).sort())).filter(elm => (elm));

                if(!callList){return;}
                
                let qslData = 
                    callList.map(
                        callSign => ({
                            "callSign": callSign,
                            "JARLBureauOrderKey": JARLBureauOrderKey(callSign),
                            "qsoData": records.filter(
                                    elm => (elm.call === callSign)
                                )
                        })
                );

                let orderByJARLRule = document.getElementById("chk_orderdByJARLRule").checked; 
                if(orderByJARLRule){
                    qslData.sort(
                            (d1,d2) => 
                                    (d1.JARLBureauOrderKey > d2.JARLBureauOrderKey) ? 1 : -1
                        );
                } 

                qslData.forEach(datum => qslPrinter(datum))

                document.querySelectorAll("img.qslImage").forEach(
                    elm => elm.setAttribute("src", qslImage)
                );

            }

            // datum is like  {callSign: "***", qsoData: [...]}
            function qslPrinter(datum){
                cardCounter++;

                let safeCallSign = datum.callSign?.replace("/","-");

                let isJA = JACallSignRegex.test(datum.callSign);
                let useJST = document.getElementById("chk_useJSTForJA")?.checked;

                let qslID = cardCounter + "_" + safeCallSign

                // Create a page / 1ページ作る
                let qsl_page = qsl_template.cloneNode(true);
                qsl_page.id = "qsl_" +  qslID;
                

                // Place the page / ページを設置
                doc_body.appendChild(qsl_page);

                // Change id for elements / IDを変更
                qsl_page.querySelectorAll("*").forEach(item => {
                    if(item.id){
                        item.id = item.id.replace("template", qslID);
                    }

                    if(item.getAttribute("for")){
                        item.setAttribute("for", item.getAttribute("for").replace("template", qslID));
                    }
                });

                // Fill the "To Radio" / "To Radio" を記入
                let txt_to_radio = qsl_page.querySelector(".box_to_radio");

                txt_to_radio.appendChild(document.createTextNode(datum.callSign));
                

                // Fill the JARL Bureau Frame / 転送枠
                let callSignBoxes_for_bureau_wrapper = qsl_page.querySelector(".table_bureau_call");
                let callSignBoxes_for_bureau = callSignBoxes_for_bureau_wrapper.querySelectorAll("tbody td");
                let callSignForBureau = JACallSignSplitter(datum.callSign);

                let isJARLStyleCheckbox = qsl_page.querySelector("#chk_JARLStyleFrame_" + qslID);

                let callSignTextBox = qsl_page.querySelector("#txt_qslto_callsign_" + qslID);

                qsl_page.querySelector("#chk_via_" + qslID).checked = false;

                if(isJA){
                    isJARLStyleCheckbox.checked = true;
                    callSignTextBox.value = callSignForBureau;
                }
                else{
                    isJARLStyleCheckbox.checked = false;
                    callSignTextBox.value = "";
                }

                qslTo_redraw(qsl_page.id);


                // Switch "QSO" or "QSOs"
                if(datum.qsoData.length > 1){
                    document.querySelector("#" + qsl_page.id + " .statement").innerText += "s";
                }


                // Create a Table for QSO Data / 表を作る
                let data_table = document.querySelector("#" + qsl_page.id + " .table_qsoData");
                let table_id = data_table.id;


                let timeZoneIndicator = document.querySelector("#" + table_id + " .tablecell_timezone");
                timeZoneIndicator.appendChild(document.createTextNode((isJA && useJST) ? "(JST)" : "(UTC)"));
                
                let maxQSOsRow = document.getElementById("num_maxRows").value;

                let maxQSOsRowInt = Number.isNaN(maxQSOsRow) ? 10 : Number.parseInt(maxQSOsRow);


                let defaultOP = document.getElementById("txt_opDefault").value;
                let defaultDE = document.getElementById("txt_deDefault").value;


                // Fill the Table / 表に書き込む
                for(let j = 0; j < datum.qsoData.length; j++){

                    if(j + 1 > maxQSOsRowInt){
                        qslPrinter(
                            {
                                callSign: datum.callSign,
                                qsoData: datum.qsoData.slice(maxQSOsRowInt)
                            }
                        )
                        break;
                    }

                    let qso = datum.qsoData[j];
                    let tableRow = data_table.tBodies[0].insertRow(-1);

                    let qsoDateTime = date_time_converter(qso.qso_date, qso.time_on || qso.time_off);

                    qsoDateTime = (isJA && useJST) ? qsoDateTime.tz("Asia/Tokyo") : qsoDateTime;

                    let dateCell = tableRow.insertCell(-1);
                    dateCell.className = "qsoDatumCell qsoDatum_date";
                    dateCell.appendChild(document.createTextNode(qsoDateTime.format("YYYY-MM-DD")));

                    let timeCell = tableRow.insertCell(-1);
                    timeCell.className = "qsoDatumCell qsoDatum_time";
                    timeCell.appendChild(document.createTextNode(qsoDateTime.format("HH:mm")));

                    let bandCell = tableRow.insertCell(-1);
                    bandCell.className = "qsoDatumCell qsoDatum_band";
                    bandCell.appendChild(document.createTextNode( !isNaN(qso.freq) ? parseFloat(qso.freq).toFixed(3) : qso.band));

                    let modeCell = tableRow.insertCell(-1);
                    modeCell.className = "qsoDatumCell qsoDatum_mode";
                    modeCell.appendChild(document.createTextNode(qso.mode));

                    let reportCell = tableRow.insertCell(-1);
                    reportCell.className = "qsoDatumCell qsoDatum_report";
                    reportCell.appendChild(document.createTextNode(qso.rst_sent));

                    let opCell = tableRow.insertCell(-1);
                    opCell.className = "qsoDatumCell qsoDatum_op";
                    opCell.appendChild(document.createTextNode(qso.operator || defaultOP || ""));

                    let deCell = tableRow.insertCell(-1);
                    deCell.className = "qsoDatumCell qsoDatum_de";
                    deCell.appendChild(document.createTextNode(qso.station_callsign || defaultDE || ""));

                    let qslMessage = (qso.qslmsgintl || "") + (qso.qslmsg || "");
                    
                    if(qslMessage.trim()!=""){
                        let msgRow = data_table.tBodies[0].insertRow(-1);
                        let msgCell = msgRow.insertCell(-1);
                        msgCell.setAttribute("colspan", 7);
                        msgCell.className="qslMsg";
                        msgCell.appendChild(document.createTextNode("(" + qslMessage.trim() + ")"));
                    }
                }                      
            }
            
        
            function date_time_converter(dateExp, timeExp = "0000"){
                if(dateExp?.length != 8 || (timeExp?.length != 4 && timeExp?.length != 6)){
                    return null;
                }

                let dateMatch = dateExp.match(/^(?<year>\d{4})(?<month>\d{2})(?<day>\d{2})$/);
                let timeMatch = timeExp.match(/^(?<hour>\d{2})(?<minute>\d{2})(?<second>\d{2})?$/);

                if(!dateMatch || !timeMatch){
                    return null;
                }

                let ISOString = dateMatch.groups.year + "-"
                    + dateMatch.groups.month + "-"
                    + dateMatch.groups.day + "T"
                    + timeMatch.groups.hour + ":"
                    + timeMatch.groups.minute + ":"
                    + (timeMatch.groups.second || "00")
                    + "Z";

                return moment.utc(ISOString);
            }

            
            function JACallSignSplitter(callSign){
                let callSignParts = callSign?.split("/");
                
                let callSignLetters = [];

                switch (callSignParts.length) {
                    case 0:
                        return null;
                        break;

                    // case 1:
                    // case 2:
                        callSignLetters = callSignParts[0];
                        break;
                    
                    default:
                        callSignLetters = callSignParts.sort((a, b) => b.length - a.length)[0];
                        break;
                }

                return callSignLetters;
            }

            function JARLBureauOrderKey(callSign){
                let baseCallSign = JACallSignSplitter(callSign);

                let resultKey = "";

                if(JACallSignRegex.test(baseCallSign)){
                    let callSignMatch = baseCallSign.match(JACallSignRegex);
                    switch(callSignMatch.groups.prefix[0]){
                        case "J":
                            resultKey = "1" 
                                    + ((parseInt(callSignMatch.groups.area) - 1 + 10)% 10 + 1).toString(16)
                                    + callSignMatch.groups.prefix
                                    + callSignMatch.groups.suffix.length
                                    + callSignMatch.groups.suffix;
                            break;

                        case "7":
                            resultKey = "7"
                                    + callSignMatch.groups.prefix
                                    + (parseInt(callSignMatch.groups.area) + 1).toString(16)
                                    + callSignMatch.groups.suffix;
                            break;

                        case "8":
                            resultKey = "8"
                                    + callSignMatch.groups.prefix
                                    + (parseInt(callSignMatch.groups.area) + 1).toString(16)
                                    + callSignMatch.groups.suffix;
                            break;

                        default:
                            resultKey = "0" + baseCallSign
                    }
                }
                else{
                    resultKey = "0" + baseCallSign
                }

                return resultKey;
            }

            function qslTo_redraw(sectionID){
                let qslPage = document.getElementById(sectionID);

                let viaCheckBox = qslPage.querySelector(".chk_via");
                let viaText = qslPage.querySelector(".txt_via")
                
                let isJARLStyleCheckBox = qslPage.querySelector(".chk_JARLStyleFrame");
                let JARLStyleCallsignBoxesWrapper =  qslPage.querySelector(".table_bureau_call");
                let JARLStyleCallsignBoxes = JARLStyleCallsignBoxesWrapper.querySelectorAll("tbody td");
            

                let qslToCallSignTextBox = qslPage.querySelector(".txt_qslto_callsign")

                if(viaCheckBox.checked){
                    viaText.classList.remove("hidden");
                }
                else {
                    viaText.classList.add("hidden");
                }


                if(isJARLStyleCheckBox.checked){
                    JARLStyleCallsignBoxes.forEach(
                        b => {
                            b.classList.add("red_bordered");
                        }
                    )
                }
                else{
                    JARLStyleCallsignBoxes.forEach(
                        b => {
                            b.classList.remove("red_bordered","dot_bordered");
                        }
                    )
                }

                for (let index = 0; index < JARLStyleCallsignBoxes.length; index++) {
                        if(index < JARLStyleCallsignBoxes.length -1){
                            JARLStyleCallsignBoxes[index].innerText = qslToCallSignTextBox.value[index] || '';
                        }
                        else{
                            JARLStyleCallsignBoxes[index]
                            .innerText = qslToCallSignTextBox.value.slice(index) || '';
                            break;
                        }
                        
                }

            }

            function switchOPField(){
                let chkDisplayOP = document.querySelector("#chk_displayOP");
                let chkStatus = chkDisplayOP.checked;

                let opFields = document.querySelectorAll(".qsoDatum_op");
                let opHeaders = document.querySelectorAll(".qsoHeader_op");


                if(chkStatus){
                    opFields.forEach(f => f.classList.remove("hidden"));
                    opHeaders.forEach(f => f.classList.remove("hidden"));
                }
                else{
                    opFields.forEach(f => f.classList.add("hidden"));
                    opHeaders.forEach(f => f.classList.add("hidden"));
                }
            }

            function switchDEField(){
                let chkDisplayDE = document.querySelector("#chk_displayDE");
                let chkStatus = chkDisplayDE.checked;

                let deFields = document.querySelectorAll(".qsoDatum_de");
                let deHeaders = document.querySelectorAll(".qsoHeader_de");


                if(chkStatus){
                    deFields.forEach(f => f.classList.remove("hidden"));
                    deHeaders.forEach(f => f.classList.remove("hidden"));
                }
                else{
                    deFields.forEach(f => f.classList.add("hidden"));
                    deHeaders.forEach(f => f.classList.add("hidden"));
                }
            }

            function cssSelector(value){

                let elm = document.getElementById("css-cardsize");
                let modified = new Date();
                let str = modified.toISOString();

                switch (value) {
                    case "ja-card":
                        elm.href="style-ja-card.css?t=" + str;
                        break;
                    
                    case "intl-card":
                        elm.href="style-intl-card.css?t=" + str;
                        break;

                    case "sticker":
                        elm.href="style-sticker.css?t=" + str;
                        break;

                    default:
                        break;
                }
            }

        </script>   



    </body>
</html>